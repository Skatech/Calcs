<!DOCTYPE html>
<head>
    <title>Inductor Calculator</title>
    <style>
        div.param {
            width: 360px;
            display: flex;
            justify-content: flex-end;
        }
        div.param span {
            position: absolute;
            left: 405px;
            margin: 7px;
        }
        div.param button {
            position: absolute;
            left: 370px;
            width: 22px;
            height: 22px;
            margin: 5px;
        }
        div.param label {
            /* display: block; */
            /* width: 360px; */
            margin: 5px;
            text-align: right;
        }
        input, select {
            width: 150px;
            padding: 1px 2px;
            box-sizing: border-box;
        }
        .error {
            border-color: red;
            background-color: rgba(255, 0, 0, 0.25);
        }
    </style>
</head>
<body>
</body>
<script>
    'use strict'
    
    class Core {
        /** @type {string} */ name
        /** @type {number} */ Se
        /** @type {number} */ le
        /** @type {number} */ Me

        /** @param {string} name @param {number} Se @param {number} le @param {number} Me */
        constructor(name, Se, le, Me) {
            Core.all.push(this)
            this.name = name
            this.Se = Se
            this.le = le
            this.Me = Me
        }

        /** @type {Core[]} */ static all = []
    }

    class State {
        /** @type {number} */ Se
        /** @type {number} */ le
        /** @type {number} */ Al
        /** @type {number} */ N
        /** @type {number} */ L
        /** @type {number} */ M0
        /** @type {number} */ Bmax

        constructor() {
            this.N = 212
            this.L = 3e-3
            this.M0 = 1.26e-6 //Math.PI * 4.0e-7 
            this.Bmax = 0.3
        }
    }

    /** @callback CalcFunc @param {State} state @returns {number} */
    /** @callback CondFunc @param {State} state @returns {boolean} */
    
    class Calculation {
        /** @type {string} */ name
        /** @type {string[]} */ deps
        /** @type {CalcFunc} */ calc
        /** @type {CondFunc} */ cond

        /** @param {string} name @param {string[]} deps @param {CalcFunc} calc @param {CondFunc | undefined} cond */
        constructor(name, deps, calc, cond) {
            Calculation.all.push(this)
            this.name = name
            this.deps = deps
            this.calc = calc
            this.cond = cond
        }

        /** @param {string} parameterName @return {bool} */
        isDependentFrom(parameterName) {
            return this.deps.includes(parameterName)
        }

        /** @param {State} state @return {bool} */
        isReadyToRun(state) {
            return this.cond?.call(this, state) ?? this.deps.every(p => state[p] !== undefined)
        }

        /** @param {State} state */
        calculate(state) {
            state[this.name] = this.calc(state)
        }

        /** @type {Calculation[]} */ static all = []

        /** @param {string} name @return {Calculation | null} */
        static find(name) {
            return Calculation.all.find(c => c.name === name)
        }
    }

    class ParameterPresenter {
        /** @type {string} */ name
        /** @type {HTMLInputElement} */ input

        /** @param {string} name */
        constructor(name) {
            this.name = name
            this.input = document.querySelector(`input[type=text]#${name}`)
            this.input.addEventListener('change', e => this.#onInputChanged(e))
            this.updateInput()
            ParameterPresenter.all.push(this)
        }

        /** @param {number | undefined} value */
        setValue(value) {
            state[this.name] = value
            this.updateInput()
        }

        updateInput() {
            this.input.value = formatValue(state[this.name])
            ParameterPresenter.updateAll(this.name)
        }

        /** @param {string} name */
        update(name) { }

        /** @param {Event} event */
        #onInputChanged(event) {
            state[this.name] = getInputValue(this.input)
            ParameterPresenter.updateAll(this.name)
        }

        /** @type {ParameterPresenter[]} */ static all = []

        /** @param {string} name @return {ParameterPresenter | null} */
        static find(name) {
            return ParameterPresenter.all.find(c => c.name === name)
        }

        /** @param {string | undefined} name */
        static updateAll(name) {
            for (const pp of ParameterPresenter.all) {
                pp.update(name)
            }
        }

        /** @param {string} rootID @param {string} name @param {string} label @param {string} descr @return {ParameterPresenter} */
        static create(rootID, name, label, descr = '') {
            const html = '<div class="param"><label>{LBL} <input type="text" id="{EID}"></label><span>{DSC}</span></div>'
                .replace('{EID}', name).replace('{LBL}', label).replace('{DSC}', descr)
            document.getElementById(rootID).appendChild(document.createElement('div')).outerHTML = html

            return new ParameterPresenter(name)
        }
    }

    class CalculationPresenter extends ParameterPresenter {
        /** @type {Calculation} */ calc
        /** @type {HTMLButtonElement} */ button

        /** @param {Calculation} calc */
        constructor(calc) {
            super(calc.name)
            this.calc = calc
            this.button = document.querySelector(`button#btn-${calc.name}`)
            this.button.addEventListener('click', e => this.#onButtonClicked(e))
            this.update()
        }

        /** @param {string | undefined} name */
        update(name) {
            if (name === undefined || this.calc.isDependentFrom(name)) {
                this.button.disabled = !this.calc.isReadyToRun(state)
            }
        }

        /** @param {Event} event */
        #onButtonClicked(event) {
            this.calc.calculate(state)
            this.updateInput()
        }

        /** @param {string} rootID @param {Calculation} calc @param {string} label @param {string} descr @return {CalculationPresenter} */
        static create(rootID, calc, label, descr = '') {
            const html = '<div class="param"><label>{LBL} <input type="text" id="{EID}"></label><button id="btn-{EID}"><</button><span>{DSC}</span></div>'
                .replaceAll('{EID}', calc.name).replace('{LBL}', label).replace('{DSC}', descr)
            document.getElementById(rootID).appendChild(document.createElement('div')).outerHTML = html

            return new CalculationPresenter(calc)
        }
    }

    class ComboSelector {
        /** @type {HTMLSelectElement} */ selector
        /** @type {Object[]} */ items
        /** @type {function(Object)} */ action

        /** @template T @param {string} id @param {T[]} items @param {function(T)} action */
        constructor(id, items, action) {
            this.action = action

            this.selector = document.querySelector(`select#${id}`)
            this.selector.addEventListener('change', e => this.#onSelectorChange(e))

            this.items = items
            for (const item of items) {
                this.selector.add(new Option(item.name))
                this.selector.selectedIndex = -1;
            }
        }

        /** @param {Event} event */
        #onSelectorChange(event) {
            this.action(this.items.find(e => e.name == event.target.value))
        }

        /** @template T @param {string} rootID @param {string} label @param {string} id @param {T[]} items @param {function(T)} action @return {ComboSelector} */
        static create(rootID, label, id, items, action) {
            const html = '<div class="param"><label>{LBL} <select id="{EID}"></select></label></div>'
                .replace('{EID}', id).replace('{LBL}', label)
            document.getElementById(rootID).appendChild(document.createElement('div')).outerHTML = html

            return new ComboSelector(id, items, action)
        }
    }

    /** @param {number} value @return {string} */
    function formatValue(value) {
        return (typeof value === 'number')
            ? (value >= 0.01)
                ? value.toPrecision(3)
                : value.toExponential(3)
            : value ?? ''
    }

    /** @param {HTMLInputElement} input @result {number} */
    function getInputValue(input) {
       try {
            const str = input.value.trim()

            if (/^[\+\-]?\d*\.?\d+(?:[Ee][\+\-]?\d+)?$/.test(str)) {
                return parseFloat(str)
            }
            else if (str.length > 0) {
                const val = eval(str)
                if (typeof val === 'number') {
                    input.value = formatValue(val)
                    return val
                }
                throw Error('Numeric value expected')
            }

            if(input.classList.contains('error')) {
                input.classList.remove('error')
            }
        }
        catch(err) {
            input.classList.add('error')
        }
        return undefined
    }

    /** @param {string} id @param {string} title @param {string | undefined} rootID @return {HTMLDivElement} */
    function CreateOptionsGroup(id, title, rootID) {
        const root = rootID ? document.getElementById(rootID) : document.body
        const elem = root.appendChild(document.createElement('div'))
        elem.outerHTML = '<div id="{GID}"><h4>{TTL}</h4></div>'.replace('{GID}', id).replace('{TTL}', title)
        return elem
    }

    const state = new State()

    /////////////////
    CreateOptionsGroup('constants', 'Constants')
    ParameterPresenter.create('constants', 'M0', 'Space permeablility M0, N/m:', 'M0 = PI * 4e-7')
    ParameterPresenter.create('constants', 'Bmax', 'Max flux density Bmax, T:', 'Bmax = 0.2 - 0.3T')

    /////////////////
    CreateOptionsGroup('core-data', 'Core Parameters')
    ComboSelector.create('core-data', 'Predefined Cores:', 'cores', [
            new Core("TMC-22", 2.26e-5, 49.8e-3, 1000),
            new Core("EE16/8/5 PC40", 1.26e-5, 29.8e-3, 2000)],
        core => ['Se', 'le', 'Me'].forEach(a => ParameterPresenter.find(a).setValue(core[a])))
    ParameterPresenter.create('core-data', 'Se', 'Core Se, m&sup2:')
    ParameterPresenter.create('core-data', 'le', 'Core le, m:')
    ParameterPresenter.create('core-data', 'Me', 'Core Me, N/m:')

    /////////////////
    CreateOptionsGroup('coil-calcs', 'Coil Calculations')
    CalculationPresenter.create('coil-calcs',
        new Calculation('Al', ['L', 'N'], s => s.L / Math.pow(s.N, 2)),
         'Al, H/N&sup2:', 'Al = L / N&sup2')
    CalculationPresenter.create('coil-calcs',
        new Calculation('N', ['L', 'Al'], s => Math.sqrt(s.L / s.Al)),
        'N:', 'N = sqrt(L / Al)')
    CalculationPresenter.create('coil-calcs',
        new Calculation('L', ['Al', 'N'], s => s.Al * Math.pow(s.N, 2)),
        'L, H:', 'L = Al * N&sup2')
</script>
</html>